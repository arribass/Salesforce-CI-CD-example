name: Validate PR on develop branch

on:
  pull_request:
    types: [opened, synchronize]
    branches: [dev]
    paths:
      - 'force-app/**'

jobs:
  validate-deployment-on-develop-org:
    runs-on: ubuntu-latest
    if: ${{ github.actor != 'dependabot[bot]' }}

    steps:
      - uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Checkout source code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # -----------------------------
      # Install Salesforce CLI
      # -----------------------------
      - name: Install Salesforce CLI
        run: |
          npm install @salesforce/cli --global
          sf version

      # -----------------------------
      # Install Plugins
      # -----------------------------
      - name: Install Plugins
        run: |
          sf plugins install sfdx-git-delta
          sf plugins install @salesforce/sfdx-scanner
          sf plugins

      # -----------------------------
      # Install Java (scanner needs it)
      # -----------------------------
      - name: Install Java
        run: |
          sudo apt-get update
          sudo apt-get install default-jdk -y
      - name: Install SGD
        run: echo y | sf plugins install "sfdx-git-delta@${{ vars.SGD_VERSION }}"
      # -----------------------------
      # Auth
      # -----------------------------
      - name: Populate auth file
        run: echo "${{ secrets.SFDX_INTEGRATION_URL }}" > sfdx_auth.txt

      - name: Authenticate org
        run: sf org login sfdx-url --sfdx-url-file sfdx_auth.txt --alias integration --set-default

      # -----------------------------
      # Generate delta (REAL ONE)
      # -----------------------------
      - name: Create delta
        run: |
          mkdir changed-sources
          sf sgd source delta \
            --to HEAD \
            --from origin/dev \
            --output-dir changed-sources \
            --generate-delta \
            --source-dir force-app

      # -----------------------------
      # Check if delta has content
      # -----------------------------
      - name: Check delta exists
        id: delta_check
        run: |
          if [ -d "changed-sources/force-app" ] && [ "$(ls -A changed-sources/force-app)" ]; then
            echo "delta_exists=true" >> $GITHUB_OUTPUT
          else
            echo "delta_exists=false" >> $GITHUB_OUTPUT
          fi

      # -----------------------------
      # Scan code (only if delta exists)
      # -----------------------------
      - name: Run Scanner
        if: steps.delta_check.outputs.delta_exists == 'true'
        run: |
          if compgen -G "changed-sources/force-app/**/*.cls" > /dev/null; then
            sf scanner run \
              --engine pmd \
              --target "changed-sources/force-app/**/*.cls" \
              --format sarif \
              --outfile changed-sources/apexScanResults.sarif || true
          else
            echo "No Apex classes to scan"
          fi

      - name: Upload SARIF
        if: hashFiles('changed-sources/apexScanResults.sarif') != ''
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: changed-sources/apexScanResults.sarif

      # -----------------------------
      # Validate Deploy (only if delta exists)
      # -----------------------------
      - name: Validate deploy delta
        if: steps.delta_check.outputs.delta_exists == 'true'
        run: |
          echo "Detecting Apex changes..."
      
          APEX_FILES=$(find changed-sources/force-app -name "*.cls")
          TEST_CLASSES=$(find changed-sources/force-app -name "*Test.cls" -exec basename {} .cls \;)
      
          if [ -n "$TEST_CLASSES" ]; then
            echo "Running specified tests:"
            echo "$TEST_CLASSES"
      
            TEST_ARGS=""
            for test in $TEST_CLASSES; do
              TEST_ARGS="$TEST_ARGS --tests $test"
            done
      
            sf project deploy start \
              --source-dir changed-sources/force-app \
              --target-org integration \
              --dry-run \
              --test-level RunSpecifiedTests \
              $TEST_ARGS \
              --wait 30 \
              --json
      
          elif [ -n "$APEX_FILES" ]; then
            echo "Apex detected but no test classes in delta → running local tests"
            sf project deploy start \
              --source-dir changed-sources/force-app \
              --target-org integration \
              --dry-run \
              --test-level RunLocalTests \
              --wait 30 \
              --json
      
          else
            echo "No Apex detected → skipping tests"
            sf project deploy start \
              --source-dir changed-sources/force-app \
              --target-org integration \
              --dry-run \
              --test-level NoTestRun \
              --wait 30 \
              --json
          fi
      # -----------------------------
      # Validate destructive changes
      # -----------------------------
      - name: Validate destructive changes
        if: hashFiles('changed-sources/destructiveChanges/destructiveChanges.xml') != ''
        run: |
          sf deploy metadata \
            --manifest changed-sources/destructiveChanges/package.xml \
            --pre-destructive-changes changed-sources/destructiveChanges/destructiveChanges.xml \
            --target-org integration \
            --dry-run \
            --wait 30
