# Unique name for this workflow
name: Deploy integration branch to integration and staging/uat orgs

# Definition when the workflow should run
on:
  push:
    branches: [ dev ]
    paths:
      - 'force-app/**'

jobs:
  deploy-branch-to-int-and-staging-orgs:
    runs-on: ubuntu-latest
    if: ${{ github.actor != 'dependabot[bot]' }}

    steps:

      # -----------------------------
      # Setup Node
      # -----------------------------
      - uses: actions/setup-node@v4
        with:
          node-version: '20'

      # -----------------------------
      # Checkout source code
      # -----------------------------
      - name: Checkout source code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # -----------------------------
      # Install Salesforce CLI (NEW)
      # -----------------------------
      - name: Install Salesforce CLI
        run: |
          npm install @salesforce/cli --global
          sf version

      # -----------------------------
      # Install sfdx-git-delta
      # -----------------------------
      - name: Install sfdx-git-delta
        run: |
          echo y | sf plugins install sfdx-git-delta
          sf plugins

      # -----------------------------
      # Install Java
      # -----------------------------
      - name: Install Java
        run: |
          sudo apt-get update
          sudo apt-get install default-jdk -y

      # -----------------------------
      # Create delta packages
      # -----------------------------
      - name: Create delta packages
        run: |
          mkdir changed-sources
          sf sgd source delta \
            --to HEAD \
            --from HEAD^ \
            --output-dir changed-sources \
            --generate-delta \
            --source-dir force-app

      # -----------------------------
      # Populate auth files
      # -----------------------------
      - name: Populate auth file with SFDX_URL secret of the integration and staging orgs
        run: |
          echo "${{ secrets.SFDX_INTEGRATION_URL }}" > ./SFDX_INTEGRATION_URL.txt
          echo "${{ secrets.SFDX_STAGING_URL }}" > ./SFDX_STAGING_URL.txt

      # -----------------------------
      # Authenticate to Integration Org
      # -----------------------------
      - name: Authenticate to Integration Org
        run: |
          sf org login sfdx-url \
            --sfdx-url-file ./SFDX_INTEGRATION_URL.txt \
            --alias integration \
            --set-default

      # -----------------------------
      # Deploy delta to Integration
      # -----------------------------
      - name: Deploy delta to Integration org
        run: |
          if [ -d "changed-sources/force-app" ] && [ "$(ls -A changed-sources/force-app)" ]; then
            sf project deploy start \
              --source-dir changed-sources/force-app \
              --target-org integration \
              --test-level RunLocalTests \
              --wait 60 \
              --json
          else
            echo "No metadata changes to deploy."
          fi

      # -----------------------------
      # Deploy destructive changes to Integration
      # -----------------------------
      - name: Deploy destructive changes to Integration org
        if: hashFiles('changed-sources/destructiveChanges/destructiveChanges.xml') != ''
        run: |
          set +e
          OUTPUT=$(sf deploy metadata \
            --manifest changed-sources/destructiveChanges/package.xml \
            --pre-destructive-changes changed-sources/destructiveChanges/destructiveChanges.xml \
            --target-org integration \
            --wait 60 2>&1)
          EXIT_CODE=$?

          echo "$OUTPUT"

          if echo "$OUTPUT" | grep -q "NothingToDeploy"; then
            echo "No destructive changes."
            exit 0
          fi

          exit $EXIT_CODE

      # -----------------------------
      # Authenticate to Staging Org
      # -----------------------------
      - name: Authenticate to Staging Org
        run: |
          sf org login sfdx-url \
            --sfdx-url-file ./SFDX_STAGING_URL.txt \
            --alias staging \
            --set-default

      # -----------------------------
      # Deploy delta to Staging org
      # -----------------------------
      - name: Deploy delta to Staging org
        run: |
          if [ -d "changed-sources/force-app" ] && [ "$(ls -A changed-sources/force-app)" ]; then
            sf project deploy start \
              --source-dir changed-sources/force-app \
              --target-org staging \
              --test-level RunLocalTests \
              --wait 60 \
              --json
          else
            echo "No metadata changes to deploy."
          fi

      # -----------------------------
      # Deploy destructive changes to Staging
      # -----------------------------
      - name: Deploy destructive changes to Staging org
        if: hashFiles('changed-sources/destructiveChanges/destructiveChanges.xml') != ''
        run: |
          set +e
          OUTPUT=$(sf deploy metadata \
            --manifest changed-sources/destructiveChanges/package.xml \
            --pre-destructive-changes changed-sources/destructiveChanges/destructiveChanges.xml \
            --target-org staging \
            --wait 60 2>&1)
          EXIT_CODE=$?

          echo "$OUTPUT"

          if echo "$OUTPUT" | grep -q "NothingToDeploy"; then
            echo "No destructive changes."
            exit 0
          fi

          exit $EXIT_CODE
